#!/usr/bin/env bash
#
# crypt - Encrypt/decrypt files/folders with AES-256-CBC
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Source library functions
source "$PROJECT_ROOT/lib/persephone/crypt.sh"

VERBOSE=false
RECURSIVE=false
PASSWORD=""
DRY_RUN=false
DECRYPT=false

usage() {
    cat <<EOF
Usage: $(basename "$0") [OPTIONS] [--] FILE...

Encrypt or decrypt files/folders using AES-256-CBC encryption.

Options:
    -h, --help           Show this help message
    -d, --decrypt        Decrypt mode (default is encrypt)
    -v, --verbose        Enable verbose output
    -R, --recursive      Recursively process directory contents
    -p, --password=PASS  Password for encryption/decryption (prompted if not provided)
    -n, --dry-run        Show what would be done without making changes

Arguments:
    FILE...          One or more files or folders to process

Examples:
    $(basename "$0") file.txt
    $(basename "$0") -d encrypted_file
    $(basename "$0") -v folder1 folder2
    $(basename "$0") -R -d encrypted_folder/
    $(basename "$0") -- -file-starting-with-dash.txt

EOF
}

main() {
    # Parse options with getopt (supports long options)
    local opts
    if ! opts=$(getopt -o dhvRp:n --long decrypt,help,verbose,recursive,password:,dry-run -n "$(basename "$0")" -- "$@"); then
        >&2 usage
        exit 1
    fi
    eval set -- "$opts"

    while true; do
        case "$1" in
            -h|--help)
                usage
                exit 0
                ;;
            -d|--decrypt)
                DECRYPT=true
                shift
                ;;
            -v|--verbose)
                VERBOSE=true
                shift
                ;;
            -R|--recursive)
                RECURSIVE=true
                shift
                ;;
            -p|--password)
                PASSWORD="$2"
                shift 2
                ;;
            -n|--dry-run)
                DRY_RUN=true
                shift
                ;;
            --)
                shift
                break
                ;;
            *)
                die "Invalid option: $1"
                ;;
        esac
    done

    # Prompt for password if not provided
    if [[ -z "$PASSWORD" ]]; then
        if [[ "$DECRYPT" == true ]]; then
            PASSWORD="$(prompt_password "Enter password: ")"
        else
            PASSWORD="$(prompt_password_confirm)"
        fi
    fi

    # Warn about short passwords
    warn_short_password "$PASSWORD"

    # Check for remaining arguments (files/folders)
    if [[ $# -eq 0 ]]; then
        log_error "No files or folders specified"
        >&2 usage
        exit 1
    fi

    # Process each file/folder
    local exit_code=0
    for item in "$@"; do
        if [[ "$DECRYPT" == true ]]; then
            if ! decrypt_item "$item"; then
                exit_code=1
            fi
        else
            if ! encrypt_item "$item"; then
                exit_code=1
            fi
        fi
    done

    exit "$exit_code"
}

main "$@"
